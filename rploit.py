import os
import glob
import requests
import pyautogui
import pyperclip
import time
import psutil
import pygetwindow as gw

def banner():
   print("""                                                     =@%-          
                                                                  =@@@%=        
                                                                   .*@@@@=      
                                                                   :#@@@@@%=    
                                                  :=:            :#@@@@@@@@@@-  
                                                 :@@@#:        :#@@@@@@@@@@@@@%-
                                                  :*@@@#-    -#@@@@@@@@@@@@@#@@@
                                                   .#@@@@%: +@@@@@@@@@@@@@*. .*@
                                                 .*@@@@@@@@#:.+@@@@@@@@@*.      
                                               .+@@@@@@@@@@@@#:.*@@@@@*:        
                                             .*@@@@@@@@@@@@@@@@#:.+@*.          
                                            +@@@@@@@@@@@@@@@@@@@@#:             
                                         .+@@@@@@@#-+@@@@@@@@@@@@@@#:           
                                       .*@@@@@@@@@+.  +@@@@@@@@@@@@@@#-         
                                      +@@@@@@@@@@@@@*. .+@@@@@@@@@@@@@@%:       
                                   .*@@@@@@@@@@@@@@@@@+. =@@@@@@@@+.:#@@@.      
                                  +@@@@@@@#-.*@@@@@@@@@@@@@@@@@@=     .-.       
                               .+@@@@@@@@@@+  :*@@@@@@@@@@@@@@+                 
                              +@@@@@@@@@@@@@@=  .*@@@@@@@@@@=                   
                           .+@@@@@@@%@@@@@@@@@%= -%@@@@@@@+                     
                         .*@@@@@@@@- .+@@@@@@@@@@@@@@@@%=                       
                        +@@@@@@@@@@%-  .#@@@@@@@@@@@@@=                         
                     .*@@@@@@@@@@@@@@%=  :*@@@@@@@@@+                           
                    +@@@@@@@##@@@@@@@@@@-=@@@@@@@@=                             
                 .+@@@@@@@@+  -#@@@@@@@@@@@@@@@@+                               
                +@@@@@@@@@@@%-  :#@@@@@@@@@@@@=                                 
               -@@@@@@@@@@@@@@#:  -@@@@@@@@@+                                   
               -@@@@@@@@@@@@@@@@%+%@@@@@@%=                                     
               :@@@@@@@@@@@@@@@@@@@@@@@@=                                       
                %@@@@@@@@@@@@@@@@@@@@@+                                         
                :@@@@@@@@@@@@@@@@@@@=                                           
               -%@@@@@@@@@@@@@@@@@+                                             
             =@@@@@@%%@@@@@@@@@@+.                                              
            *@@@@@%=  .:-======                                                 
           :#%%@*:                                                              
         .*@+                                                                   
       :#@*.                                                                    
     .*@+                                                                       
   :*@*.                                                                        
 :*%+.                                                                          
*@+                                                                             
""")


def inject_lua_code(game_id, auth_cookie, lua_code):
    url = f"https://www.roblox.com/games/{game_id}/place"
    headers = {
        "Cookie": f".ROBLOSECURITY={auth_cookie}"
    }
    payload = {
        "code": lua_code
    }

    response = requests.post(url, headers=headers, data=payload)

    if response.status_code == 200:
        print("Código Lua injetado com sucesso!")
    else:
        print(f"Falha ao injetar código Lua. Código de status: {response.status_code}")

def create_bat_script(script_name, game_id, auth_cookie, lua_code):
    bat_code = f'@echo off\npython -c "import os; os.system(\'python {script_name} {game_id} {auth_cookie} "{lua_code}"\')"'
    with open("inject_script.bat", "w") as bat_file:
        bat_file.write(bat_code)

def read_script_file(file_path):
    with open(file_path, "r") as file:
        return file.read()

def get_browser_url():
    pyautogui.hotkey("ctrl", "l")
    pyautogui.hotkey("ctrl", "c")
    time.sleep(0.5)
    return pyperclip.paste()

def get_browser_auth_cookie():
    browser_process_names = ["chrome", "msedge", "firefox"]

    for proc in psutil.process_iter(['pid', 'name']):
        if proc.info['name'].lower() in browser_process_names:
            try:
                browser_window = gw.getWindowsWithTitle(proc.info['name'])[0]
                browser_window.activate()
                pyautogui.hotkey("ctrl", "l")
                pyautogui.hotkey("ctrl", "c")
                time.sleep(0.5)
                auth_cookie = pyperclip.paste()
                return auth_cookie.strip()
            except IndexError:
                pass

    print("Nenhuma janela do navegador foi encontrada.")
    return None

def main():
    print("Aguarde enquanto o script detecta o auth_cookie automaticamente...")

    auth_cookie = get_browser_auth_cookie()

    if not auth_cookie:
        print("O auth_cookie não foi detectado automaticamente. Por favor, forneça-o manualmente.")
        auth_cookie = input("Digite o auth_cookie: ")

    print("Auth_cookie detectado com sucesso:", auth_cookie)

    print("Por favor, abra o navegador e acesse a página do jogo no Roblox.")
    input("Pressione Enter após acessar a página do jogo.")

    game_id = None
    while not game_id:
        url = get_browser_url()
        if "roblox.com/games/" in url:
            game_id = url.split("/games/")[1].split("/")[0]

    lua_code = select_script_file()

    if not lua_code:
        return

    inject_lua_code(game_id, auth_cookie, lua_code)

    script_name = os.path.basename(__file__)  # Nome do próprio script Python
    create_bat_script(script_name, game_id, auth_cookie, lua_code)

    # Executa o arquivo .bat
    os.system("inject_script.bat")

def select_script_file():
    scripts_folder = "scripts"
    script_files = glob.glob(os.path.join(scripts_folder, "*.*"))

    if not script_files:
        print("Nenhum arquivo de script encontrado na pasta 'scripts'.")
        return None

    print("Arquivos de script encontrados:")
    for idx, script_file in enumerate(script_files, start=1):
        print(f"{idx}. {os.path.basename(script_file)}")

    print(f"{idx + 1}. Digitar o próprio código Lua")
    selected_script = None
    while selected_script is None:
        user_input = input("Digite o número do arquivo de script ou 'd' para digitar o próprio código: ")

        if user_input.lower() == 'd':
            lua_code = input("Digite o código Lua: ")
            return lua_code

        try:
            selected_idx = int(user_input)
            if 1 <= selected_idx <= len(script_files):
                selected_script = script_files[selected_idx - 1]
            else:
                print("Número inválido. Por favor, selecione um número válido.")
        except ValueError:
            print("Entrada inválida. Por favor, digite um número ou 'd' para digitar o próprio código.")

    # Ler o conteúdo do arquivo selecionado
    script_extension = os.path.splitext(selected_script)[1].lower()
    if script_extension in [".py", ".txt", ".lua"]:
        lua_code = read_script_file(selected_script)
        pyperclip.copy(lua_code)
        print("Código do script copiado para a área de transferência.")
        return lua_code
    else:
        print(f"Extensão de arquivo '{script_extension}' não suportada.")
        return None

if __name__ == "__main__":
    main()
